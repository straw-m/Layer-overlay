<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vueå¤šå›¾å±‚å åŠ å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            min-height: 80vh;
        }

        .preview-section {
            flex: 1;
            background: #f8f9fa;
            padding: 30px;
            border-right: 2px solid #e9ecef;
        }

        .controls-section {
            width: 550px;
            background: white;
            padding: 30px;
            overflow-y: auto;
            max-height: 90vh;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }

        .preview-container {
            background: #fff;
            border: 2px dashed #dee2e6;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-canvas {
            max-width: 100%;
            max-height: 500px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input[type="range"] {
            padding: 0;
            height: 8px;
            background: linear-gradient(90deg, #e9ecef 0%, #3498db 50%, #e9ecef 100%);
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
            margin: 10px 0;
        }

        .form-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .form-group input[type="range"]::-webkit-slider-thumb:hover {
            background: #2980b9;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .form-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .form-group input[type="range"]::-moz-range-thumb:hover {
            background: #2980b9;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .form-group input[type="range"]:focus {
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* é¢œè‰²æ»‘å—ç‰¹æ®Šæ ·å¼ */
        .color-group div:nth-child(1) input[type="range"] {
            background: linear-gradient(90deg, #000 0%, #f00 100%);
        }

        .color-group div:nth-child(2) input[type="range"] {
            background: linear-gradient(90deg, #000 0%, #0f0 100%);
        }

        .color-group div:nth-child(3) input[type="range"] {
            background: linear-gradient(90deg, #000 0%, #00f 100%);
        }

        .color-group div:nth-child(4) input[type="range"] {
            background: linear-gradient(90deg, transparent 0%, #000 100%);
        }

        .color-group .help-text {
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
            margin-top: 5px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            opacity: 0;
            position: absolute;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-display {
            display: block;
            padding: 15px;
            border: 2px dashed #3498db;
            border-radius: 10px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-display:hover {
            background: #e8f2ff;
            border-color: #2980b9;
        }

        .position-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .color-group {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .section-divider {
            margin: 30px 0;
            border-top: 2px solid #e9ecef;
            position: relative;
        }

        .section-divider::before {
            content: attr(data-title);
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 15px;
            color: #7f8c8d;
            font-size: 12px;
            font-weight: 600;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #2980b9, #2c3e50);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-section {
            margin-top: 20px;
            padding: 20px;
            background: #e3f2fd;
            border-radius: 10px;
            border-left: 4px solid #2196f3;
        }

        .progress-section.hidden {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2196f3, #21cbf3);
            transition: width 0.3s ease;
            width: 0%;
        }

        .result-section {
            margin-top: 30px;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 10px;
            border-left: 4px solid #27ae60;
        }

        .result-section.hidden {
            display: none;
        }

        .download-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .download-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #229954, #27ae60);
            transform: translateY(-2px);
        }

        .download-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .file-list {
            margin-top: 10px;
            font-size: 12px;
            color: #7f8c8d;
        }

        .help-text {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }

        .no-preview {
            color: #7f8c8d;
            font-size: 16px;
        }

        .debug-info {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            font-size: 12px;
            color: #856404;
        }

        .layer-sub-section {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .layer-sub-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 14px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .proportional-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 8px;
        }

        .proportional-toggle label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
            color: #2c3e50;
        }

        .proportional-toggle input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .controls-section {
                width: 100%;
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- å·¦ä¾§é¢„è§ˆåŒºåŸŸ -->
            <div class="preview-section">
                <h2 class="section-title">ğŸ¨ å®æ—¶é¢„è§ˆ</h2>
                <div class="preview-container">
                    <canvas 
                        ref="previewCanvas" 
                        class="preview-canvas"
                        v-show="layer1Images.length > 0"
                        :width="settings.layer1Width" 
                        :height="settings.layer1Height">
                    </canvas>
                    <div v-show="layer1Images.length === 0" class="no-preview">
                        ä¸Šä¼ å›¾å±‚1åå°†åœ¨æ­¤æ˜¾ç¤ºå¤šå›¾å±‚å åŠ é¢„è§ˆæ•ˆæœ<br>
                        <small>æ”¯æŒ1ä¸ªèƒŒæ™¯å±‚ + 4ä¸ªç›¸åŒå›¾ç‰‡çš„ç‹¬ç«‹å›¾å±‚ + 2ä¸ªé¢å¤–å›¾å±‚ + 1ä¸ªæ–‡å­—å±‚</small>
                    </div>
                </div>
                <div class="debug-info" v-if="debugInfo">
                    {{ debugInfo }}
                </div>
            </div>

            <!-- å³ä¾§æ§åˆ¶åŒºåŸŸ -->
            <div class="controls-section">
                <h2 class="section-title">âš™ï¸ å¤šå›¾å±‚å‚æ•°è®¾ç½®</h2>
                
                <!-- å›¾å±‚1è®¾ç½®ï¼ˆèƒŒæ™¯å±‚ï¼‰ -->
                <div class="form-group">
                    <label>ğŸ“· å›¾å±‚1 - èƒŒæ™¯å›¾ç‰‡ï¼ˆå¿…éœ€ï¼‰</label>
                    <div class="file-input-wrapper">
                        <input 
                            type="file" 
                            class="file-input" 
                            multiple 
                            accept="image/*" 
                            @change="handleLayer1Upload"
                            ref="layer1Input">
                        <div class="file-input-display">
                            ç‚¹å‡»é€‰æ‹©èƒŒæ™¯å›¾ç‰‡æ–‡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰
                        </div>
                    </div>
                    <div class="file-list" v-show="layer1Images.length > 0">
                        å·²é€‰æ‹© {{ layer1Images.length }} ä¸ªæ–‡ä»¶
                    </div>
                </div>

                <div class="proportional-toggle">
                    <label>
                        <input type="checkbox" v-model="settings.layer1Proportional">
                        ğŸ”— ç­‰æ¯”ä¾‹ç¼©æ”¾
                    </label>
                </div>

                <div class="position-group">
                    <div class="form-group">
                        <label>å®½åº¦ (px)</label>
                        <input type="range" v-model.number="settings.layer1Width" min="100" max="2000" step="2" @input="handleLayer1SizeChange('width')">
                        <div class="help-text">å½“å‰å€¼: {{ settings.layer1Width }}px</div>
                    </div>
                    <div class="form-group">
                        <label>é«˜åº¦ (px)</label>
                        <input type="range" v-model.number="settings.layer1Height" min="100" max="2000" step="2" @input="handleLayer1SizeChange('height')">
                        <div class="help-text">å½“å‰å€¼: {{ settings.layer1Height }}px</div>
                    </div>
                </div>

                <div class="section-divider" data-title="å›¾å±‚2-5è®¾ç½®ï¼ˆ4ä¸ªç›¸åŒå›¾ç‰‡çš„ç‹¬ç«‹å›¾å±‚ï¼‰"></div>

                <!-- å›¾å±‚2-5å…±äº«ä¸Šä¼ ç»„ä»¶ -->
                <div class="form-group">
                    <label>ğŸ–¼ï¸ å›¾å±‚2-5å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰- å°†åˆ›å»º4ä¸ªç‹¬ç«‹å›¾å±‚</label>
                    <div class="file-input-wrapper">
                        <input 
                            type="file" 
                            class="file-input" 
                            multiple 
                            accept="image/*" 
                            @change="handleMultiLayerUpload"
                            ref="multiLayerInput">
                        <div class="file-input-display">
                            ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼ˆå°†ç”¨äºå›¾å±‚2-5ï¼‰
                        </div>
                    </div>
                    <div class="file-list" v-show="multiLayerImages.length > 0">
                        å·²é€‰æ‹© {{ multiLayerImages.length }} ä¸ªæ–‡ä»¶ï¼Œå°†ç”¨äº4ä¸ªç‹¬ç«‹å›¾å±‚
                    </div>
                </div>

                <!-- å›¾å±‚2è®¾ç½® -->
                <div class="layer-sub-section">
                    <div class="layer-sub-title">ğŸ“ å›¾å±‚2è®¾ç½®</div>
                    
                    <div class="proportional-toggle">
                        <label>
                            <input type="checkbox" v-model="settings.layer2Proportional">
                            ğŸ”— ç­‰æ¯”ä¾‹ç¼©æ”¾
                        </label>
                    </div>

                    <div class="position-group">
                        <div class="form-group">
                            <label>Xåæ ‡</label>
                            <input type="range" v-model.number="settings.layer2XPos" min="0" max="1000" step="2" @input="updatePreview">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer2XPos }}px</div>
                        </div>
                        <div class="form-group">
                            <label>Yåæ ‡</label>
                            <input type="range" v-model.number="settings.layer2YPos" min="0" max="1000" step="2" @input="updatePreview">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer2YPos }}px</div>
                        </div>
                    </div>

                    <div class="position-group">
                        <div class="form-group">
                            <label>å®½åº¦ (0=åŸå§‹)</label>
                            <input type="range" v-model.number="settings.layer2Width" min="0" max="1000" step="2" @input="handleLayer2SizeChange('width')">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer2Width === 0 ? 'åŸå§‹å°ºå¯¸' : settings.layer2Width + 'px' }}</div>
                        </div>
                        <div class="form-group">
                            <label>é«˜åº¦ (0=åŸå§‹)</label>
                            <input type="range" v-model.number="settings.layer2Height" min="0" max="1000" step="2" @input="handleLayer2SizeChange('height')">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer2Height === 0 ? 'åŸå§‹å°ºå¯¸' : settings.layer2Height + 'px' }}</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ—‹è½¬è§’åº¦ (åº¦)</label>
                        <input type="range" v-model.number="settings.layer2Rotation" min="-360" max="360" step="2" @input="updatePreview">
                        <div class="help-text">å½“å‰è§’åº¦: {{ settings.layer2Rotation }}Â°</div>
                    </div>
                </div>

                <!-- å›¾å±‚3è®¾ç½® -->
                <div class="layer-sub-section">
                    <div class="layer-sub-title">ğŸ“ å›¾å±‚3è®¾ç½®</div>
                    
                    <div class="proportional-toggle">
                        <label>
                            <input type="checkbox" v-model="settings.layer3Proportional">
                            ğŸ”— ç­‰æ¯”ä¾‹ç¼©æ”¾
                        </label>
                    </div>

                    <div class="position-group">
                        <div class="form-group">
                            <label>Xåæ ‡</label>
                            <input type="range" v-model.number="settings.layer3XPos" min="0" max="1000" step="2" @input="updatePreview">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer3XPos }}px</div>
                        </div>
                        <div class="form-group">
                            <label>Yåæ ‡</label>
                            <input type="range" v-model.number="settings.layer3YPos" min="0" max="1000" step="2" @input="updatePreview">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer3YPos }}px</div>
                        </div>
                    </div>

                    <div class="position-group">
                        <div class="form-group">
                            <label>å®½åº¦ (0=åŸå§‹)</label>
                            <input type="range" v-model.number="settings.layer3Width" min="0" max="1000" step="2" @input="handleLayer3SizeChange('width')">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer3Width === 0 ? 'åŸå§‹å°ºå¯¸' : settings.layer3Width + 'px' }}</div>
                        </div>
                        <div class="form-group">
                            <label>é«˜åº¦ (0=åŸå§‹)</label>
                            <input type="range" v-model.number="settings.layer3Height" min="0" max="1000" step="2" @input="handleLayer3SizeChange('height')">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer3Height === 0 ? 'åŸå§‹å°ºå¯¸' : settings.layer3Height + 'px' }}</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ—‹è½¬è§’åº¦ (åº¦)</label>
                        <input type="range" v-model.number="settings.layer3Rotation" min="-360" max="360" step="2" @input="updatePreview">
                        <div class="help-text">å½“å‰è§’åº¦: {{ settings.layer3Rotation }}Â°</div>
                    </div>
                </div>

                <!-- å›¾å±‚4è®¾ç½® -->
                <div class="layer-sub-section">
                    <div class="layer-sub-title">ğŸ“ å›¾å±‚4è®¾ç½®</div>
                    
                    <div class="proportional-toggle">
                        <label>
                            <input type="checkbox" v-model="settings.layer4Proportional">
                            ğŸ”— ç­‰æ¯”ä¾‹ç¼©æ”¾
                        </label>
                    </div>

                    <div class="position-group">
                        <div class="form-group">
                            <label>Xåæ ‡</label>
                            <input type="range" v-model.number="settings.layer4XPos" min="0" max="1000" step="2" @input="updatePreview">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer4XPos }}px</div>
                        </div>
                        <div class="form-group">
                            <label>Yåæ ‡</label>
                            <input type="range" v-model.number="settings.layer4YPos" min="0" max="1000" step="2" @input="updatePreview">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer4YPos }}px</div>
                        </div>
                    </div>

                    <div class="position-group">
                        <div class="form-group">
                            <label>å®½åº¦ (0=åŸå§‹)</label>
                            <input type="range" v-model.number="settings.layer4Width" min="0" max="1000" step="2" @input="handleLayer4SizeChange('width')">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer4Width === 0 ? 'åŸå§‹å°ºå¯¸' : settings.layer4Width + 'px' }}</div>
                        </div>
                        <div class="form-group">
                            <label>é«˜åº¦ (0=åŸå§‹)</label>
                            <input type="range" v-model.number="settings.layer4Height" min="0" max="1000" step="2" @input="handleLayer4SizeChange('height')">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer4Height === 0 ? 'åŸå§‹å°ºå¯¸' : settings.layer4Height + 'px' }}</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ—‹è½¬è§’åº¦ (åº¦)</label>
                        <input type="range" v-model.number="settings.layer4Rotation" min="-360" max="360" step="2" @input="updatePreview">
                        <div class="help-text">å½“å‰è§’åº¦: {{ settings.layer4Rotation }}Â°</div>
                    </div>
                </div>

                <!-- å›¾å±‚5è®¾ç½® -->
                <div class="layer-sub-section">
                    <div class="layer-sub-title">ğŸ“ å›¾å±‚5è®¾ç½®</div>
                    
                    <div class="proportional-toggle">
                        <label>
                            <input type="checkbox" v-model="settings.layer5Proportional">
                            ğŸ”— ç­‰æ¯”ä¾‹ç¼©æ”¾
                        </label>
                    </div>

                    <div class="position-group">
                        <div class="form-group">
                            <label>Xåæ ‡</label>
                            <input type="range" v-model.number="settings.layer5XPos" min="0" max="1000" step="2" @input="updatePreview">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer5XPos }}px</div>
                        </div>
                        <div class="form-group">
                            <label>Yåæ ‡</label>
                            <input type="range" v-model.number="settings.layer5YPos" min="0" max="1000" step="2" @input="updatePreview">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer5YPos }}px</div>
                        </div>
                    </div>

                    <div class="position-group">
                        <div class="form-group">
                            <label>å®½åº¦ (0=åŸå§‹)</label>
                            <input type="range" v-model.number="settings.layer5Width" min="0" max="1000" step="2" @input="handleLayer5SizeChange('width')">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer5Width === 0 ? 'åŸå§‹å°ºå¯¸' : settings.layer5Width + 'px' }}</div>
                        </div>
                        <div class="form-group">
                            <label>é«˜åº¦ (0=åŸå§‹)</label>
                            <input type="range" v-model.number="settings.layer5Height" min="0" max="1000" step="2" @input="handleLayer5SizeChange('height')">
                            <div class="help-text">å½“å‰å€¼: {{ settings.layer5Height === 0 ? 'åŸå§‹å°ºå¯¸' : settings.layer5Height + 'px' }}</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ—‹è½¬è§’åº¦ (åº¦)</label>
                        <input type="range" v-model.number="settings.layer5Rotation" min="-360" max="360" step="2" @input="updatePreview">
                        <div class="help-text">å½“å‰è§’åº¦: {{ settings.layer5Rotation }}Â°</div>
                    </div>
                </div>

                <div class="section-divider" data-title="å›¾å±‚6è®¾ç½®ï¼ˆé¢å¤–å›¾å±‚ï¼‰"></div>

                <!-- å›¾å±‚6è®¾ç½® -->
                <div class="form-group">
                    <label>ğŸ–¼ï¸ å›¾å±‚6å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                    <div class="file-input-wrapper">
                        <input 
                            type="file" 
                            class="file-input" 
                            multiple 
                            accept="image/*" 
                            @change="handleLayer6Upload"
                            ref="layer6Input">
                        <div class="file-input-display">
                            ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰
                        </div>
                    </div>
                    <div class="file-list" v-show="layer6Images.length > 0">
                        å·²é€‰æ‹© {{ layer6Images.length }} ä¸ªæ–‡ä»¶
                    </div>
                </div>

                <div class="proportional-toggle">
                    <label>
                        <input type="checkbox" v-model="settings.layer6Proportional">
                        ğŸ”— ç­‰æ¯”ä¾‹ç¼©æ”¾
                    </label>
                </div>

                <div class="position-group">
                    <div class="form-group">
                        <label>Xåæ ‡</label>
                        <input type="range" v-model.number="settings.layer6XPos" min="0" max="1000" step="2" @input="updatePreview">
                        <div class="help-text">å½“å‰å€¼: {{ settings.layer6XPos }}px</div>
                    </div>
                    <div class="form-group">
                        <label>Yåæ ‡</label>
                        <input type="range" v-model.number="settings.layer6YPos" min="0" max="1000" step="2" @input="updatePreview">
                        <div class="help-text">å½“å‰å€¼: {{ settings.layer6YPos }}px</div>
                    </div>
                </div>

                <div class="position-group">
                    <div class="form-group">
                        <label>å®½åº¦ (0=åŸå§‹)</label>
                        <input type="range" v-model.number="settings.layer6Width" min="0" max="1000" step="2" @input="handleLayer6SizeChange('width')">
                        <div class="help-text">å½“å‰å€¼: {{ settings.layer6Width === 0 ? 'åŸå§‹å°ºå¯¸' : settings.layer6Width + 'px' }}</div>
                    </div>
                    <div class="form-group">
                        <label>é«˜åº¦ (0=åŸå§‹)</label>
                        <input type="range" v-model.number="settings.layer6Height" min="0" max="1000" step="2" @input="handleLayer6SizeChange('height')">
                        <div class="help-text">å½“å‰å€¼: {{ settings.layer6Height === 0 ? 'åŸå§‹å°ºå¯¸' : settings.layer6Height + 'px' }}</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ—‹è½¬è§’åº¦ (åº¦)</label>
                    <input type="range" v-model.number="settings.layer6Rotation" min="-360" max="360" step="2" @input="updatePreview">
                    <div class="help-text">å½“å‰è§’åº¦: {{ settings.layer6Rotation }}Â°</div>
                </div>

                <div class="section-divider" data-title="å›¾å±‚7è®¾ç½®ï¼ˆé¢å¤–å›¾å±‚ï¼‰"></div>

                <!-- å›¾å±‚7è®¾ç½® -->
                <div class="form-group">
                    <label>ğŸ–¼ï¸ å›¾å±‚7å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                    <div class="file-input-wrapper">
                        <input 
                            type="file" 
                            class="file-input" 
                            multiple 
                            accept="image/*" 
                            @change="handleLayer7Upload"
                            ref="layer7Input">
                        <div class="file-input-display">
                            ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰
                        </div>
                    </div>
                    <div class="file-list" v-show="layer7Images.length > 0">
                        å·²é€‰æ‹© {{ layer7Images.length }} ä¸ªæ–‡ä»¶
                    </div>
                </div>

                <div class="proportional-toggle">
                    <label>
                        <input type="checkbox" v-model="settings.layer7Proportional">
                        ğŸ”— ç­‰æ¯”ä¾‹ç¼©æ”¾
                    </label>
                </div>

                <div class="position-group">
                    <div class="form-group">
                        <label>Xåæ ‡</label>
                        <input type="range" v-model.number="settings.layer7XPos" min="0" max="1000" step="2" @input="updatePreview">
                        <div class="help-text">å½“å‰å€¼: {{ settings.layer7XPos }}px</div>
                    </div>
                    <div class="form-group">
                        <label>Yåæ ‡</label>
                        <input type="range" v-model.number="settings.layer7YPos" min="0" max="1000" step="2" @input="updatePreview">
                        <div class="help-text">å½“å‰å€¼: {{ settings.layer7YPos }}px</div>
                    </div>
                </div>

                <div class="position-group">
                    <div class="form-group">
                        <label>å®½åº¦ (0=åŸå§‹)</label>
                        <input type="range" v-model.number="settings.layer7Width" min="0" max="1000" step="2" @input="handleLayer7SizeChange('width')">
                        <div class="help-text">å½“å‰å€¼: {{ settings.layer7Width === 0 ? 'åŸå§‹å°ºå¯¸' : settings.layer7Width + 'px' }}</div>
                    </div>
                    <div class="form-group">
                        <label>é«˜åº¦ (0=åŸå§‹)</label>
                        <input type="range" v-model.number="settings.layer7Height" min="0" max="1000" step="2" @input="handleLayer7SizeChange('height')">
                        <div class="help-text">å½“å‰å€¼: {{ settings.layer7Height === 0 ? 'åŸå§‹å°ºå¯¸' : settings.layer7Height + 'px' }}</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ—‹è½¬è§’åº¦ (åº¦)</label>
                    <input type="range" v-model.number="settings.layer7Rotation" min="-360" max="360" step="2" @input="updatePreview">
                    <div class="help-text">å½“å‰è§’åº¦: {{ settings.layer7Rotation }}Â°</div>
                </div>

                <div class="section-divider" data-title="æ–‡å­—å±‚è®¾ç½®ï¼ˆå¯é€‰ï¼‰"></div>

                <!-- æ–‡å­—è®¾ç½® -->
                <div class="form-group">
                    <label>âœï¸ æ–‡å­—å†…å®¹</label>
                    <textarea v-model="settings.textContent" rows="3" placeholder="è¾“å…¥æ–‡å­—å†…å®¹ï¼Œç”¨ / åˆ†å‰²å¤šä¸ªæ–‡å­—ï¼Œå¦‚ï¼šå¥”é©°/å®é©¬/ç¦ç‰¹" @input="updatePreview"></textarea>
                    <div class="help-text">ç”¨ / åˆ†å‰²å¤šä¸ªæ–‡å­—ï¼Œæ¯ä¸ªæ–‡å­—å°†ç”Ÿæˆå•ç‹¬çš„ç»„åˆ</div>
                </div>

                <div class="position-group">
                    <div class="form-group">
                        <label>Xåæ ‡</label>
                        <input type="range" v-model.number="settings.textXPos" min="0" max="1000" step="2" @input="updatePreview">
                        <div class="help-text">å½“å‰å€¼: {{ settings.textXPos }}px</div>
                    </div>
                    <div class="form-group">
                        <label>Yåæ ‡</label>
                        <input type="range" v-model.number="settings.textYPos" min="0" max="1000" step="2" @input="updatePreview">
                        <div class="help-text">å½“å‰å€¼: {{ settings.textYPos }}px</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>å­—ä½“å¤§å°</label>
                    <input type="range" v-model.number="settings.fontSize" min="10" max="200" step="2" @input="updatePreview">
                    <div class="help-text">å½“å‰å€¼: {{ settings.fontSize }}px</div>
                </div>

                <div class="form-group">
                    <label>æ—‹è½¬è§’åº¦ (åº¦)</label>
                    <input type="range" v-model.number="settings.textRotation" min="-360" max="360" step="2" @input="updatePreview">
                    <div class="help-text">å½“å‰è§’åº¦: {{ settings.textRotation }}Â°</div>
                </div>

                <div class="form-group">
                    <label>æ–‡å­—é¢œè‰²</label>
                    <div class="color-group">
                        <div>
                            <label>çº¢(R)</label>
                            <input type="range" v-model.number="settings.textColor.r" min="0" max="255" step="1" @input="updatePreview">
                            <div class="help-text">{{ settings.textColor.r }}</div>
                        </div>
                        <div>
                            <label>ç»¿(G)</label>
                            <input type="range" v-model.number="settings.textColor.g" min="0" max="255" step="1" @input="updatePreview">
                            <div class="help-text">{{ settings.textColor.g }}</div>
                        </div>
                        <div>
                            <label>è“(B)</label>
                            <input type="range" v-model.number="settings.textColor.b" min="0" max="255" step="1" @input="updatePreview">
                            <div class="help-text">{{ settings.textColor.b }}</div>
                        </div>
                        <div>
                            <label>é€æ˜åº¦</label>
                            <input type="range" v-model.number="settings.textColor.a" min="0" max="255" step="1" @input="updatePreview">
                            <div class="help-text">{{ settings.textColor.a }}</div>
                        </div>
                    </div>
                    <div class="help-text" style="margin-top: 10px; text-align: center; padding: 10px; border-radius: 5px;" :style="{ backgroundColor: `rgba(${settings.textColor.r}, ${settings.textColor.g}, ${settings.textColor.b}, ${settings.textColor.a/255})`, color: settings.textColor.r + settings.textColor.g + settings.textColor.b > 380 ? '#000' : '#fff' }">
                        é¢œè‰²é¢„è§ˆ: rgba({{ settings.textColor.r }}, {{ settings.textColor.g }}, {{ settings.textColor.b }}, {{ (settings.textColor.a/255).toFixed(2) }})
                    </div>
                </div>

                <button 
                    class="submit-btn" 
                    @click="generateImages" 
                    :disabled="isProcessing || layer1Images.length === 0">
                    <span v-if="!isProcessing">ğŸš€ å¼€å§‹ç”Ÿæˆå¤šå›¾å±‚ç»„åˆ</span>
                    <span v-else>ğŸ”„ ç”Ÿæˆä¸­...</span>
                </button>

                <!-- è¿›åº¦æ˜¾ç¤º -->
                <div class="progress-section" :class="{ hidden: !isProcessing }">
                    <h3>ğŸ“Š ç”Ÿæˆè¿›åº¦</h3>
                    <p>{{ progressText }}</p>
                    <div class="progress-bar">
                        <div class="progress-fill" :style="{ width: progressPercent + '%' }"></div>
                    </div>
                    <p>{{ currentProgress }} / {{ totalImages }}</p>
                </div>

                <!-- ç»“æœæ˜¾ç¤º -->
                <div class="result-section" :class="{ hidden: !showResult }">
                    <h3>âœ… ç”Ÿæˆå®Œæˆ</h3>
                    <p><strong>æ€»å…±ç”Ÿæˆ:</strong> {{ totalImages }} å¼ å›¾ç‰‡ (JPEGæ ¼å¼)</p>
                    <p><strong>å›¾å±‚ç»„åˆ:</strong> 7ä¸ªå›¾ç‰‡å›¾å±‚ + 1ä¸ªæ–‡å­—å›¾å±‚</p>
                    <p><strong>æ–‡ä»¶å¤§å°:</strong> {{ formatFileSize(zipSize) }}</p>
                    <p><strong>ZIPçŠ¶æ€:</strong> {{ zipBlob ? 'âœ… å·²å‡†å¤‡' : 'âŒ æœªç”Ÿæˆ' }}</p>
                    <button class="download-btn" @click="downloadZip" :disabled="!zipBlob">
                        ğŸ“¦ ä¸‹è½½ZIPæ–‡ä»¶
                    </button>
                    <div class="help-text" style="margin-top: 10px;">
                        <strong>ğŸ“Œ Windowsç”¨æˆ·æ³¨æ„ï¼š</strong><br>
                        å¦‚æœä¸‹è½½åæ— æ³•æ‰“å¼€ZIPæ–‡ä»¶ï¼Œè¯·å³é”®ç‚¹å‡»æ–‡ä»¶ â†’ å±æ€§ â†’ å‹¾é€‰"è§£é™¤é˜»æ­¢" â†’ ç¡®å®š<br>
                        æˆ–ç›´æ¥è§£å‹åˆ°æ–‡ä»¶å¤¹ä¸­æŸ¥çœ‹å›¾ç‰‡
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, nextTick, onMounted } = Vue;

        createApp({
            setup() {
                // å“åº”å¼æ•°æ®
                const layer1Images = ref([]);
                const multiLayerImages = ref([]); // å›¾å±‚2-5å…±äº«çš„å›¾ç‰‡
                const layer6Images = ref([]);
                const layer7Images = ref([]);
                const previewCanvas = ref(null);
                const layer1Input = ref(null);
                const multiLayerInput = ref(null);
                const layer6Input = ref(null);
                const layer7Input = ref(null);
                const isProcessing = ref(false);
                const showResult = ref(false);
                const progressText = ref('');
                const progressPercent = ref(0);
                const currentProgress = ref(0);
                const totalImages = ref(0);
                const zipBlob = ref(null);
                const zipSize = ref(0);
                const debugInfo = ref('');
                
                // å„å›¾å±‚çš„åŸå§‹å®½é«˜æ¯”
                const layer1OriginalRatio = ref(1);
                const multiLayerOriginalRatio = ref(1);
                const layer6OriginalRatio = ref(1);
                const layer7OriginalRatio = ref(1);

                const settings = reactive({
                    layer1Width: 800,
                    layer1Height: 800,
                    layer1Proportional: false,
                    // å›¾å±‚2-5ç‹¬ç«‹è®¾ç½®
                    layer2XPos: 0,
                    layer2YPos: 0,
                    layer2Width: 0,
                    layer2Height: 0,
                    layer2Rotation: 0,
                    layer2Proportional: false,
                    layer3XPos: 0,
                    layer3YPos: 0,
                    layer3Width: 0,
                    layer3Height: 0,
                    layer3Rotation: 0,
                    layer3Proportional: false,
                    layer4XPos: 0,
                    layer4YPos: 0,
                    layer4Width: 0,
                    layer4Height: 0,
                    layer4Rotation: 0,
                    layer4Proportional: false,
                    layer5XPos: 0,
                    layer5YPos: 0,
                    layer5Width: 0,
                    layer5Height: 0,
                    layer5Rotation: 0,
                    layer5Proportional: false,
                    // å›¾å±‚6-7è®¾ç½®
                    layer6XPos: 0,
                    layer6YPos: 0,
                    layer6Width: 0,
                    layer6Height: 0,
                    layer6Rotation: 0,
                    layer6Proportional: false,
                    layer7XPos: 0,
                    layer7YPos: 0,
                    layer7Width: 0,
                    layer7Height: 0,
                    layer7Rotation: 0,
                    layer7Proportional: false,
                    // æ–‡å­—è®¾ç½®
                    textContent: '',
                    textXPos: 0,
                    textYPos: 0,
                    fontSize: 40,
                    textRotation: 0,
                    textColor: {
                        r: 0,
                        g: 0,
                        b: 0,
                        a: 255
                    }
                });

                // æ·»åŠ è°ƒè¯•æ—¥å¿—
                const log = (message) => {
                    console.log(message);
                    debugInfo.value = new Date().toLocaleTimeString() + ': ' + message;
                };

                // å¤„ç†å„å›¾å±‚å°ºå¯¸å˜åŒ–
                const handleLayer1SizeChange = (dimension) => {
                    if (settings.layer1Proportional) {
                        if (dimension === 'width') {
                            settings.layer1Height = Math.round(settings.layer1Width / layer1OriginalRatio.value);
                        } else {
                            settings.layer1Width = Math.round(settings.layer1Height * layer1OriginalRatio.value);
                        }
                    }
                    updatePreview();
                };

                const handleLayer2SizeChange = (dimension) => {
                    if (settings.layer2Proportional && multiLayerImages.value.length > 0) {
                        if (dimension === 'width' && settings.layer2Width > 0) {
                            settings.layer2Height = Math.round(settings.layer2Width / multiLayerOriginalRatio.value);
                        } else if (dimension === 'height' && settings.layer2Height > 0) {
                            settings.layer2Width = Math.round(settings.layer2Height * multiLayerOriginalRatio.value);
                        }
                    }
                    updatePreview();
                };

                const handleLayer3SizeChange = (dimension) => {
                    if (settings.layer3Proportional && multiLayerImages.value.length > 0) {
                        if (dimension === 'width' && settings.layer3Width > 0) {
                            settings.layer3Height = Math.round(settings.layer3Width / multiLayerOriginalRatio.value);
                        } else if (dimension === 'height' && settings.layer3Height > 0) {
                            settings.layer3Width = Math.round(settings.layer3Height * multiLayerOriginalRatio.value);
                        }
                    }
                    updatePreview();
                };

                const handleLayer4SizeChange = (dimension) => {
                    if (settings.layer4Proportional && multiLayerImages.value.length > 0) {
                        if (dimension === 'width' && settings.layer4Width > 0) {
                            settings.layer4Height = Math.round(settings.layer4Width / multiLayerOriginalRatio.value);
                        } else if (dimension === 'height' && settings.layer4Height > 0) {
                            settings.layer4Width = Math.round(settings.layer4Height * multiLayerOriginalRatio.value);
                        }
                    }
                    updatePreview();
                };

                const handleLayer5SizeChange = (dimension) => {
                    if (settings.layer5Proportional && multiLayerImages.value.length > 0) {
                        if (dimension === 'width' && settings.layer5Width > 0) {
                            settings.layer5Height = Math.round(settings.layer5Width / multiLayerOriginalRatio.value);
                        } else if (dimension === 'height' && settings.layer5Height > 0) {
                            settings.layer5Width = Math.round(settings.layer5Height * multiLayerOriginalRatio.value);
                        }
                    }
                    updatePreview();
                };

                const handleLayer6SizeChange = (dimension) => {
                    if (settings.layer6Proportional && layer6Images.value.length > 0) {
                        if (dimension === 'width' && settings.layer6Width > 0) {
                            settings.layer6Height = Math.round(settings.layer6Width / layer6OriginalRatio.value);
                        } else if (dimension === 'height' && settings.layer6Height > 0) {
                            settings.layer6Width = Math.round(settings.layer6Height * layer6OriginalRatio.value);
                        }
                    }
                    updatePreview();
                };

                const handleLayer7SizeChange = (dimension) => {
                    if (settings.layer7Proportional && layer7Images.value.length > 0) {
                        if (dimension === 'width' && settings.layer7Width > 0) {
                            settings.layer7Height = Math.round(settings.layer7Width / layer7OriginalRatio.value);
                        } else if (dimension === 'height' && settings.layer7Height > 0) {
                            settings.layer7Width = Math.round(settings.layer7Height * layer7OriginalRatio.value);
                        }
                    }
                    updatePreview();
                };

                // æ–‡ä»¶ä¸Šä¼ å¤„ç†
                const handleLayer1Upload = async (event) => {
                    try {
                        log('å¼€å§‹ä¸Šä¼ å›¾å±‚1æ–‡ä»¶...');
                        const files = Array.from(event.target.files);
                        layer1Images.value = [];
                        
                        for (const file of files) {
                            log(`æ­£åœ¨åŠ è½½æ–‡ä»¶: ${file.name}`);
                            const img = await loadImage(file);
                            layer1Images.value.push(img);
                        }
                        
                        if (layer1Images.value.length > 0) {
                            layer1OriginalRatio.value = layer1Images.value[0].width / layer1Images.value[0].height;
                        }
                        
                        log(`å›¾å±‚1æ–‡ä»¶åŠ è½½å®Œæˆï¼Œå…± ${layer1Images.value.length} ä¸ªæ–‡ä»¶`);
                        await nextTick();
                        updatePreview();
                    } catch (error) {
                        log(`å›¾å±‚1ä¸Šä¼ å¤±è´¥: ${error.message}`);
                        console.error('å›¾å±‚1ä¸Šä¼ å¤±è´¥:', error);
                    }
                };

                const handleMultiLayerUpload = async (event) => {
                    try {
                        log('å¼€å§‹ä¸Šä¼ å›¾å±‚2-5æ–‡ä»¶...');
                        const files = Array.from(event.target.files);
                        multiLayerImages.value = [];
                        
                        for (const file of files) {
                            log(`æ­£åœ¨åŠ è½½æ–‡ä»¶: ${file.name}`);
                            const img = await loadImage(file);
                            multiLayerImages.value.push(img);
                        }
                        
                        if (multiLayerImages.value.length > 0) {
                            multiLayerOriginalRatio.value = multiLayerImages.value[0].width / multiLayerImages.value[0].height;
                        }
                        
                        log(`å›¾å±‚2-5æ–‡ä»¶åŠ è½½å®Œæˆï¼Œå…± ${multiLayerImages.value.length} ä¸ªæ–‡ä»¶`);
                        await nextTick();
                        updatePreview();
                    } catch (error) {
                        log(`å›¾å±‚2-5ä¸Šä¼ å¤±è´¥: ${error.message}`);
                        console.error('å›¾å±‚2-5ä¸Šä¼ å¤±è´¥:', error);
                    }
                };

                const handleLayer6Upload = async (event) => {
                    try {
                        log('å¼€å§‹ä¸Šä¼ å›¾å±‚6æ–‡ä»¶...');
                        const files = Array.from(event.target.files);
                        layer6Images.value = [];
                        
                        for (const file of files) {
                            log(`æ­£åœ¨åŠ è½½æ–‡ä»¶: ${file.name}`);
                            const img = await loadImage(file);
                            layer6Images.value.push(img);
                        }
                        
                        if (layer6Images.value.length > 0) {
                            layer6OriginalRatio.value = layer6Images.value[0].width / layer6Images.value[0].height;
                        }
                        
                        log(`å›¾å±‚6æ–‡ä»¶åŠ è½½å®Œæˆï¼Œå…± ${layer6Images.value.length} ä¸ªæ–‡ä»¶`);
                        await nextTick();
                        updatePreview();
                    } catch (error) {
                        log(`å›¾å±‚6ä¸Šä¼ å¤±è´¥: ${error.message}`);
                        console.error('å›¾å±‚6ä¸Šä¼ å¤±è´¥:', error);
                    }
                };

                const handleLayer7Upload = async (event) => {
                    try {
                        log('å¼€å§‹ä¸Šä¼ å›¾å±‚7æ–‡ä»¶...');
                        const files = Array.from(event.target.files);
                        layer7Images.value = [];
                        
                        for (const file of files) {
                            log(`æ­£åœ¨åŠ è½½æ–‡ä»¶: ${file.name}`);
                            const img = await loadImage(file);
                            layer7Images.value.push(img);
                        }
                        
                        if (layer7Images.value.length > 0) {
                            layer7OriginalRatio.value = layer7Images.value[0].width / layer7Images.value[0].height;
                        }
                        
                        log(`å›¾å±‚7æ–‡ä»¶åŠ è½½å®Œæˆï¼Œå…± ${layer7Images.value.length} ä¸ªæ–‡ä»¶`);
                        await nextTick();
                        updatePreview();
                    } catch (error) {
                        log(`å›¾å±‚7ä¸Šä¼ å¤±è´¥: ${error.message}`);
                        console.error('å›¾å±‚7ä¸Šä¼ å¤±è´¥:', error);
                    }
                };

                // å›¾ç‰‡åŠ è½½
                const loadImage = (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                console.log(`å›¾ç‰‡åŠ è½½æˆåŠŸ: ${file.name}, å°ºå¯¸: ${img.width}x${img.height}`);
                                resolve(img);
                            };
                            img.onerror = (error) => {
                                console.error(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${file.name}`, error);
                                reject(new Error(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${file.name}`));
                            };
                            img.src = e.target.result;
                        };
                        reader.onerror = (error) => {
                            console.error(`æ–‡ä»¶è¯»å–å¤±è´¥: ${file.name}`, error);
                            reject(new Error(`æ–‡ä»¶è¯»å–å¤±è´¥: ${file.name}`));
                        };
                        reader.readAsDataURL(file);
                    });
                };

                // é¢„è§ˆæ›´æ–°
                const updatePreview = async () => {
                    try {
                        if (layer1Images.value.length === 0 || !previewCanvas.value) return;
                        
                        await nextTick();
                        const canvas = previewCanvas.value;
                        const ctx = canvas.getContext('2d');
                        
                        // æ¸…ç©ºç”»å¸ƒ
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        
                        // ç»˜åˆ¶å›¾å±‚1ï¼ˆèƒŒæ™¯ï¼‰
                        const layer1 = layer1Images.value[0];
                        ctx.drawImage(layer1, 0, 0, settings.layer1Width, settings.layer1Height);
                        
                        // ç»˜åˆ¶å›¾å±‚2-5ï¼ˆå¦‚æœæœ‰å›¾ç‰‡ï¼‰
                        if (multiLayerImages.value.length > 0) {
                            const img = multiLayerImages.value[0];
                            // ç»˜åˆ¶å›¾å±‚2
                            drawLayer(ctx, img, 'layer2');
                            // ç»˜åˆ¶å›¾å±‚3
                            drawLayer(ctx, img, 'layer3');
                            // ç»˜åˆ¶å›¾å±‚4
                            drawLayer(ctx, img, 'layer4');
                            // ç»˜åˆ¶å›¾å±‚5
                            drawLayer(ctx, img, 'layer5');
                        }
                        
                        // ç»˜åˆ¶å›¾å±‚6
                        if (layer6Images.value.length > 0) {
                            drawLayer(ctx, layer6Images.value[0], 'layer6');
                        }
                        
                        // ç»˜åˆ¶å›¾å±‚7
                        if (layer7Images.value.length > 0) {
                            drawLayer(ctx, layer7Images.value[0], 'layer7');
                        }
                        
                        // ç»˜åˆ¶æ–‡å­—ï¼ˆæœ€ä¸Šå±‚ï¼‰
                        if (settings.textContent.trim()) {
                            const texts = settings.textContent.split('/').map(t => t.trim()).filter(t => t);
                            if (texts.length > 0) {
                                drawText(ctx, texts[0]);
                            }
                        }
                    } catch (error) {
                        console.error('é¢„è§ˆæ›´æ–°å¤±è´¥:', error);
                        log(`é¢„è§ˆæ›´æ–°å¤±è´¥: ${error.message}`);
                    }
                };

                // ç»˜åˆ¶å›¾å±‚ï¼ˆé€šç”¨å‡½æ•°ï¼‰
                const drawLayer = (ctx, img, layerName) => {
                    try {
                        const x = settings[`${layerName}XPos`];
                        const y = settings[`${layerName}YPos`];
                        const w = settings[`${layerName}Width`] || img.width;
                        const h = settings[`${layerName}Height`] || img.height;
                        const rotation = settings[`${layerName}Rotation`] * Math.PI / 180;
                        
                        ctx.save();
                        ctx.translate(x + w/2, y + h/2);
                        ctx.rotate(rotation);
                        ctx.drawImage(img, -w/2, -h/2, w, h);
                        ctx.restore();
                    } catch (error) {
                        console.error(`ç»˜åˆ¶${layerName}å¤±è´¥:`, error);
                    }
                };

                // ç»˜åˆ¶æ–‡å­—
                const drawText = (ctx, text) => {
                    try {
                        if (!text) return;
                        
                        const x = settings.textXPos;
                        const y = settings.textYPos;
                        const fontSize = settings.fontSize;
                        const rotation = settings.textRotation * Math.PI / 180;
                        const color = settings.textColor;
                        
                        ctx.save();
                        ctx.font = `${fontSize}px Arial, sans-serif`;
                        ctx.fillStyle = `rgba(${color.r}, ${color.g}, ${color.b}, ${color.a/255})`;
                        ctx.textBaseline = 'top';
                        
                        const textMetrics = ctx.measureText(text);
                        const textWidth = textMetrics.width;
                        const textHeight = fontSize;
                        
                        ctx.translate(x + textWidth/2, y + textHeight/2);
                        ctx.rotate(rotation);
                        ctx.fillText(text, -textWidth/2, -textHeight/2);
                        ctx.restore();
                    } catch (error) {
                        console.error('ç»˜åˆ¶æ–‡å­—å¤±è´¥:', error);
                    }
                };

                // ç”Ÿæˆæ‰€æœ‰å›¾ç‰‡ç»„åˆ
                const generateImages = async () => {
                    if (layer1Images.value.length === 0) {
                        alert('è¯·å…ˆä¸Šä¼ å›¾å±‚1å›¾ç‰‡');
                        return;
                    }
                    
                    console.log('å¼€å§‹ç”Ÿæˆå›¾ç‰‡...');
                    log('å¼€å§‹ç”Ÿæˆå›¾ç‰‡...');
                    
                    isProcessing.value = true;
                    showResult.value = false;
                    progressPercent.value = 0;
                    currentProgress.value = 0;
                    
                    try {
                        // æ£€æŸ¥JSZipæ˜¯å¦å¯ç”¨
                        if (typeof JSZip === 'undefined') {
                            throw new Error('JSZipåº“æœªåŠ è½½');
                        }
                        
                        const zip = new JSZip();
                        const texts = settings.textContent.trim() ? 
                            settings.textContent.split('/').map(t => t.trim()).filter(t => t) : [''];
                        
                        // è®¡ç®—æ‰€æœ‰å¯èƒ½çš„ç»„åˆæ•°é‡
                        const multiLayerList = multiLayerImages.value.length > 0 ? multiLayerImages.value : [null];
                        const layer6List = layer6Images.value.length > 0 ? layer6Images.value : [null];
                        const layer7List = layer7Images.value.length > 0 ? layer7Images.value : [null];
                        
                        totalImages.value = layer1Images.value.length * multiLayerList.length * layer6List.length * layer7List.length * texts.length;
                        log(`è®¡åˆ’ç”Ÿæˆ ${totalImages.value} å¼ å›¾ç‰‡`);
                        
                        let count = 0;
                        
                        // ç”Ÿæˆæ‰€æœ‰ç»„åˆ
                        for (let i = 0; i < layer1Images.value.length; i++) {
                            for (let j = 0; j < multiLayerList.length; j++) {
                                for (let k = 0; k < layer6List.length; k++) {
                                    for (let l = 0; l < layer7List.length; l++) {
                                        for (let m = 0; m < texts.length; m++) {
                                            try {
                                                log(`æ­£åœ¨ç”Ÿæˆç¬¬ ${count + 1} å¼ å›¾ç‰‡...`);
                                                
                                                const canvas = document.createElement('canvas');
                                                canvas.width = settings.layer1Width;
                                                canvas.height = settings.layer1Height;
                                                const ctx = canvas.getContext('2d');
                                                
                                                // ç»˜åˆ¶å›¾å±‚1ï¼ˆèƒŒæ™¯ï¼‰
                                                ctx.drawImage(layer1Images.value[i], 0, 0, settings.layer1Width, settings.layer1Height);
                                                
                                                // ç»˜åˆ¶å›¾å±‚2-5ï¼ˆå¦‚æœæœ‰å›¾ç‰‡ï¼‰
                                                if (multiLayerList[j]) {
                                                    // ç»˜åˆ¶å›¾å±‚2
                                                    drawLayer(ctx, multiLayerList[j], 'layer2');
                                                    // ç»˜åˆ¶å›¾å±‚3
                                                    drawLayer(ctx, multiLayerList[j], 'layer3');
                                                    // ç»˜åˆ¶å›¾å±‚4
                                                    drawLayer(ctx, multiLayerList[j], 'layer4');
                                                    // ç»˜åˆ¶å›¾å±‚5
                                                    drawLayer(ctx, multiLayerList[j], 'layer5');
                                                }
                                                
                                                // ç»˜åˆ¶å›¾å±‚6
                                                if (layer6List[k]) {
                                                    drawLayer(ctx, layer6List[k], 'layer6');
                                                }
                                                
                                                // ç»˜åˆ¶å›¾å±‚7
                                                if (layer7List[l]) {
                                                    drawLayer(ctx, layer7List[l], 'layer7');
                                                }
                                                
                                                // ç»˜åˆ¶æ–‡å­—
                                                if (texts[m]) {
                                                    drawText(ctx, texts[m]);
                                                }
                                                
                                                // è½¬æ¢ä¸ºblobå¹¶æ·»åŠ åˆ°zip
                                                const blob = await canvasToBlob(canvas);
                                                const filename = `combined_${i+1}_${j+1}_${k+1}_${l+1}_${m+1}.jpg`;
                                                zip.file(filename, blob);
                                                
                                                count++;
                                                currentProgress.value = count;
                                                progressPercent.value = (count / totalImages.value) * 100;
                                                progressText.value = `æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ ${count}/${totalImages.value}`;
                                                
                                                // è®©UIæœ‰æœºä¼šæ›´æ–°
                                                await new Promise(resolve => setTimeout(resolve, 50));
                                            } catch (error) {
                                                console.error(`ç”Ÿæˆå›¾ç‰‡å¤±è´¥:`, error);
                                                throw new Error(`ç”Ÿæˆç¬¬${count+1}å¼ å›¾ç‰‡å¤±è´¥: ${error.message}`);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        log('æ­£åœ¨æ‰“åŒ…ZIPæ–‡ä»¶...');
                        progressText.value = 'æ­£åœ¨æ‰“åŒ…ZIPæ–‡ä»¶...';
                        progressPercent.value = 95;
                        
                        // ç”ŸæˆZIPæ–‡ä»¶
                        const zipOptions = {
                            type: 'blob',
                            compression: 'DEFLATE',
                            compressionOptions: {
                                level: 3
                            },
                            platform: 'DOS',
                            mimeType: 'application/zip'
                        };
                        
                        zipBlob.value = await zip.generateAsync(zipOptions);
                        zipSize.value = zipBlob.value.size;
                        
                        progressPercent.value = 100;
                        progressText.value = 'ç”Ÿæˆå®Œæˆï¼';
                        showResult.value = true;
                        
                        log(`ç”Ÿæˆå®Œæˆï¼å…± ${totalImages.value} å¼ å›¾ç‰‡ï¼ŒZIPå¤§å°: ${formatFileSize(zipSize.value)}`);
                        
                        // è‡ªåŠ¨ä¸‹è½½
                        setTimeout(() => {
                            downloadZip();
                        }, 1000);
                        
                    } catch (error) {
                        console.error('ç”Ÿæˆè¿‡ç¨‹å‡ºé”™:', error);
                        log(`ç”Ÿæˆå¤±è´¥: ${error.message}`);
                        alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
                    } finally {
                        isProcessing.value = false;
                    }
                };

                // Canvasè½¬Blob
                const canvasToBlob = (canvas, mimeType = 'image/jpeg', quality = 0.95) => {
                    return new Promise((resolve, reject) => {
                        try {
                            if (canvas.toBlob) {
                                canvas.toBlob((blob) => {
                                    if (blob) {
                                        resolve(blob);
                                    } else {
                                        reject(new Error('Canvasè½¬æ¢å¤±è´¥'));
                                    }
                                }, mimeType, quality);
                            } else {
                                const dataURL = canvas.toDataURL(mimeType, quality);
                                const blob = dataURLToBlob(dataURL);
                                resolve(blob);
                            }
                        } catch (error) {
                            reject(error);
                        }
                    });
                };

                // DataURLè½¬Blob
                const dataURLToBlob = (dataURL) => {
                    const arr = dataURL.split(',');
                    const mime = arr[0].match(/:(.*?);/)[1];
                    const bstr = atob(arr[1]);
                    let n = bstr.length;
                    const u8arr = new Uint8Array(n);
                    while (n--) {
                        u8arr[n] = bstr.charCodeAt(n);
                    }
                    return new Blob([u8arr], { type: mime });
                };

                // ä¸‹è½½ZIPæ–‡ä»¶
                const downloadZip = () => {
                    if (!zipBlob.value) {
                        alert('ZIPæ–‡ä»¶è¿˜æœªç”Ÿæˆï¼Œè¯·å…ˆç”Ÿæˆå›¾ç‰‡');
                        return;
                    }
                    
                    try {
                        log('å¼€å§‹ä¸‹è½½ZIPæ–‡ä»¶...');
                        
                        if (!window.URL || !window.URL.createObjectURL) {
                            alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶ä¸‹è½½åŠŸèƒ½ï¼Œè¯·æ›´æ–°æµè§ˆå™¨');
                            return;
                        }
                        
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                        const filename = `layered_images_${timestamp}.zip`;
                        
                        const safeBlob = new Blob([zipBlob.value], { 
                            type: 'application/zip' 
                        });
                        
                        const url = URL.createObjectURL(safeBlob);
                        const link = document.createElement('a');
                        link.style.display = 'none';
                        link.href = url;
                        link.download = filename;
                        
                        link.setAttribute('download', filename);
                        link.setAttribute('type', 'application/zip');
                        
                        document.body.appendChild(link);
                        link.click();
                        
                        setTimeout(() => {
                            if (document.body.contains(link)) {
                                document.body.removeChild(link);
                            }
                            URL.revokeObjectURL(url);
                            log('ZIPæ–‡ä»¶ä¸‹è½½å®Œæˆ');
                        }, 1000);
                        
                    } catch (error) {
                        console.error('ä¸‹è½½å¤±è´¥:', error);
                        log(`ä¸‹è½½å¤±è´¥: ${error.message}`);
                        alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®æˆ–ç¨åé‡è¯•: ' + error.message);
                        
                        try {
                            const url = URL.createObjectURL(zipBlob.value);
                            window.open(url, '_blank');
                        } catch (fallbackError) {
                            console.error('å¤‡ç”¨ä¸‹è½½æ–¹æ¡ˆä¹Ÿå¤±è´¥:', fallbackError);
                        }
                    }
                };

                // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                const formatFileSize = (bytes) => {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                };

                // ç»„ä»¶æŒ‚è½½åè®¾ç½®é¢„è§ˆ
                onMounted(() => {
                    log('ç»„ä»¶å·²æŒ‚è½½');
                    nextTick(() => {
                        updatePreview();
                    });
                });

                return {
                    layer1Images,
                    multiLayerImages,
                    layer6Images,
                    layer7Images,
                    previewCanvas,
                    layer1Input,
                    multiLayerInput,
                    layer6Input,
                    layer7Input,
                    settings,
                    isProcessing,
                    showResult,
                    progressText,
                    progressPercent,
                    currentProgress,
                    totalImages,
                    zipBlob,
                    zipSize,
                    debugInfo,
                    handleLayer1Upload,
                    handleMultiLayerUpload,
                    handleLayer6Upload,
                    handleLayer7Upload,
                    handleLayer1SizeChange,
                    handleLayer2SizeChange,
                    handleLayer3SizeChange,
                    handleLayer4SizeChange,
                    handleLayer5SizeChange,
                    handleLayer6SizeChange,
                    handleLayer7SizeChange,
                    updatePreview,
                    generateImages,
                    downloadZip,
                    formatFileSize
                };
            }
        }).mount('#app');
    </script>
</body>
</html>